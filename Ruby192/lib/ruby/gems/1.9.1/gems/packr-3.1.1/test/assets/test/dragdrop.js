if(typeof Effect=='undefined')throw("dragdrop.js requires including script.aculo.us' effects.js library");var Droppables={drops:[],remove:function(b){this.drops=this.drops.reject(function(a){return a.element==$(b)})},add:function(b){b=$(b);var c=Object.extend({greedy:true,hoverclass:null,tree:false},arguments[1]||{});if(c.containment){c._containers=[];var d=c.containment;if((typeof d=='object')&&(d.constructor==Array)){d.each(function(a){c._containers.push($(a))})}else{c._containers.push($(d))}}if(c.accept)c.accept=[c.accept].flatten();Element.makePositioned(b);c.element=b;this.drops.push(c)},findDeepestChild:function(a){deepest=a[0];for(i=1;i<a.length;++i)if(Element.isParent(a[i].element,deepest.element))deepest=a[i];return deepest},isContained:function(b,c){var d;if(c.tree){d=b.treeNode}else{d=b.parentNode}return c._containers.detect(function(a){return d==a})},isAffected:function(b,c,d){return((d.element!=c)&&((!d._containers)||this.isContained(c,d))&&((!d.accept)||(Element.classNames(c).detect(function(a){return d.accept.include(a)})))&&Position.within(d.element,b[0],b[1]))},deactivate:function(a){if(a.hoverclass)Element.removeClassName(a.element,a.hoverclass);this.last_active=null},activate:function(a){if(a.hoverclass)Element.addClassName(a.element,a.hoverclass);this.last_active=a},show:function(b,c){if(!this.drops.length)return;var d=[];if(this.last_active)this.deactivate(this.last_active);this.drops.each(function(a){if(Droppables.isAffected(b,c,a))d.push(a)});if(d.length>0){drop=Droppables.findDeepestChild(d);Position.within(drop.element,b[0],b[1]);if(drop.onHover)drop.onHover(c,drop.element,Position.overlap(drop.overlap,drop.element));Droppables.activate(drop)}},fire:function(a,b){if(!this.last_active)return;Position.prepare();if(this.isAffected([Event.pointerX(a),Event.pointerY(a)],b,this.last_active))if(this.last_active.onDrop)this.last_active.onDrop(b,this.last_active.element,a)},reset:function(){if(this.last_active)this.deactivate(this.last_active)}}var Draggables={drags:[],observers:[],register:function(a){if(this.drags.length==0){this.eventMouseUp=this.endDrag.bindAsEventListener(this);this.eventMouseMove=this.updateDrag.bindAsEventListener(this);this.eventKeypress=this.keyPress.bindAsEventListener(this);Event.observe(document,"mouseup",this.eventMouseUp);Event.observe(document,"mousemove",this.eventMouseMove);Event.observe(document,"keypress",this.eventKeypress)}this.drags.push(a)},unregister:function(b){this.drags=this.drags.reject(function(a){return a==b});if(this.drags.length==0){Event.stopObserving(document,"mouseup",this.eventMouseUp);Event.stopObserving(document,"mousemove",this.eventMouseMove);Event.stopObserving(document,"keypress",this.eventKeypress)}},activate:function(a){if(a.options.delay){this._timeout=setTimeout(function(){Draggables._timeout=null;window.focus();Draggables.activeDraggable=a}.bind(this),a.options.delay)}else{window.focus();this.activeDraggable=a}},deactivate:function(){this.activeDraggable=null},updateDrag:function(a){if(!this.activeDraggable)return;var b=[Event.pointerX(a),Event.pointerY(a)];if(this._lastPointer&&(this._lastPointer.inspect()==b.inspect()))return;this._lastPointer=b;this.activeDraggable.updateDrag(a,b)},endDrag:function(a){if(this._timeout){clearTimeout(this._timeout);this._timeout=null}if(!this.activeDraggable)return;this._lastPointer=null;this.activeDraggable.endDrag(a);this.activeDraggable=null},keyPress:function(a){if(this.activeDraggable)this.activeDraggable.keyPress(a)},addObserver:function(a){this.observers.push(a);this._cacheObserverCallbacks()},removeObserver:function(b){this.observers=this.observers.reject(function(a){return a.element==b});this._cacheObserverCallbacks()},notify:function(a,b,c){if(this[a+'Count']>0)this.observers.each(function(o){if(o[a])o[a](a,b,c)});if(b.options[a])b.options[a](b,c)},_cacheObserverCallbacks:function(){['onStart','onEnd','onDrag'].each(function(b){Draggables[b+'Count']=Draggables.observers.select(function(a){return a[b]}).length})}}var Draggable=Class.create();Draggable._dragging={};Draggable.prototype={initialize:function(f){var g={handle:false,reverteffect:function(a,b,c){var d=Math.sqrt(Math.abs(b^2)+Math.abs(c^2))*0.02;new Effect.Move(a,{x:-c,y:-b,duration:d,queue:{scope:'_draggable',position:'end'}})},endeffect:function(a){var b=typeof a._opacity=='number'?a._opacity:1.0;new Effect.Opacity(a,{duration:0.2,from:0.7,to:b,queue:{scope:'_draggable',position:'end'},afterFinish:function(){Draggable._dragging[a]=false}})},zindex:1000,revert:false,scroll:false,scrollSensitivity:20,scrollSpeed:15,snap:false,delay:0};if(!arguments[1]||typeof arguments[1].endeffect=='undefined')Object.extend(g,{starteffect:function(a){a._opacity=Element.getOpacity(a);Draggable._dragging[a]=true;new Effect.Opacity(a,{duration:0.2,from:a._opacity,to:0.7})}});var e=Object.extend(g,arguments[1]||{});this.element=$(f);if(e.handle&&(typeof e.handle=='string'))this.handle=this.element.down('.'+e.handle,0);if(!this.handle)this.handle=$(e.handle);if(!this.handle)this.handle=this.element;if(e.scroll&&!e.scroll.scrollTo&&!e.scroll.outerHTML){e.scroll=$(e.scroll);this._isScrollChild=Element.childOf(this.element,e.scroll)}Element.makePositioned(this.element);this.delta=this.currentDelta();this.options=e;this.dragging=false;this.eventMouseDown=this.initDrag.bindAsEventListener(this);Event.observe(this.handle,"mousedown",this.eventMouseDown);Draggables.register(this)},destroy:function(){Event.stopObserving(this.handle,"mousedown",this.eventMouseDown);Draggables.unregister(this)},currentDelta:function(){return([parseInt(Element.getStyle(this.element,'left')||'0'),parseInt(Element.getStyle(this.element,'top')||'0')])},initDrag:function(b){if(typeof Draggable._dragging[this.element]!='undefined'&&Draggable._dragging[this.element])return;if(Event.isLeftClick(b)){var c=Event.element(b);if(c.tagName&&(c.tagName=='INPUT'||c.tagName=='SELECT'||c.tagName=='OPTION'||c.tagName=='BUTTON'||c.tagName=='TEXTAREA'))return;var d=[Event.pointerX(b),Event.pointerY(b)];var f=Position.cumulativeOffset(this.element);this.offset=[0,1].map(function(a){return(d[a]-f[a])});Draggables.activate(this);Event.stop(b)}},startDrag:function(a){this.dragging=true;if(this.options.zindex){this.originalZ=parseInt(Element.getStyle(this.element,'z-index')||0);this.element.style.zIndex=this.options.zindex}if(this.options.ghosting){this._clone=this.element.cloneNode(true);Position.absolutize(this.element);this.element.parentNode.insertBefore(this._clone,this.element)}if(this.options.scroll){if(this.options.scroll==window){var b=this._getWindowScroll(this.options.scroll);this.originalScrollLeft=b.left;this.originalScrollTop=b.top}else{this.originalScrollLeft=this.options.scroll.scrollLeft;this.originalScrollTop=this.options.scroll.scrollTop}}Draggables.notify('onStart',this,a);if(this.options.starteffect)this.options.starteffect(this.element)},updateDrag:function(a,b){if(!this.dragging)this.startDrag(a);Position.prepare();Droppables.show(b,this.element);Draggables.notify('onDrag',this,a);this.draw(b);if(this.options.change)this.options.change(this);if(this.options.scroll){this.stopScrolling();var c;if(this.options.scroll==window){with(this._getWindowScroll(this.options.scroll)){c=[left,top,left+width,top+height]}}else{c=Position.page(this.options.scroll);c[0]+=this.options.scroll.scrollLeft+Position.deltaX;c[1]+=this.options.scroll.scrollTop+Position.deltaY;c.push(c[0]+this.options.scroll.offsetWidth);c.push(c[1]+this.options.scroll.offsetHeight)}var d=[0,0];if(b[0]<(c[0]+this.options.scrollSensitivity))d[0]=b[0]-(c[0]+this.options.scrollSensitivity);if(b[1]<(c[1]+this.options.scrollSensitivity))d[1]=b[1]-(c[1]+this.options.scrollSensitivity);if(b[0]>(c[2]-this.options.scrollSensitivity))d[0]=b[0]-(c[2]-this.options.scrollSensitivity);if(b[1]>(c[3]-this.options.scrollSensitivity))d[1]=b[1]-(c[3]-this.options.scrollSensitivity);this.startScrolling(d)}if(navigator.appVersion.indexOf('AppleWebKit')>0)window.scrollBy(0,0);Event.stop(a)},finishDrag:function(a,b){this.dragging=false;if(this.options.ghosting){Position.relativize(this.element);Element.remove(this._clone);this._clone=null}if(b)Droppables.fire(a,this.element);Draggables.notify('onEnd',this,a);var c=this.options.revert;if(c&&typeof c=='function')c=c(this.element);var d=this.currentDelta();if(c&&this.options.reverteffect){this.options.reverteffect(this.element,d[1]-this.delta[1],d[0]-this.delta[0])}else{this.delta=d}if(this.options.zindex)this.element.style.zIndex=this.originalZ;if(this.options.endeffect)this.options.endeffect(this.element);Draggables.deactivate(this);Droppables.reset()},keyPress:function(a){if(a.keyCode!=Event.KEY_ESC)return;this.finishDrag(a,false);Event.stop(a)},endDrag:function(a){if(!this.dragging)return;this.stopScrolling();this.finishDrag(a,true);Event.stop(a)},draw:function(c){var d=Position.cumulativeOffset(this.element);if(this.options.ghosting){var f=Position.realOffset(this.element);d[0]+=f[0]-Position.deltaX;d[1]+=f[1]-Position.deltaY}var g=this.currentDelta();d[0]-=g[0];d[1]-=g[1];if(this.options.scroll&&(this.options.scroll!=window&&this._isScrollChild)){d[0]-=this.options.scroll.scrollLeft-this.originalScrollLeft;d[1]-=this.options.scroll.scrollTop-this.originalScrollTop}var e=[0,1].map(function(a){return(c[a]-d[a]-this.offset[a])}.bind(this));if(this.options.snap){if(typeof this.options.snap=='function'){e=this.options.snap(e[0],e[1],this)}else{if(this.options.snap instanceof Array){e=e.map(function(a,b){return Math.round(a/this.options.snap[b])*this.options.snap[b]}.bind(this))}else{e=e.map(function(a){return Math.round(a/this.options.snap)*this.options.snap}.bind(this))}}}var h=this.element.style;if((!this.options.constraint)||(this.options.constraint=='horizontal'))h.left=e[0]+"px";if((!this.options.constraint)||(this.options.constraint=='vertical'))h.top=e[1]+"px";if(h.visibility=="hidden")h.visibility=""},stopScrolling:function(){if(this.scrollInterval){clearInterval(this.scrollInterval);this.scrollInterval=null;Draggables._lastScrollPointer=null}},startScrolling:function(a){if(!(a[0]||a[1]))return;this.scrollSpeed=[a[0]*this.options.scrollSpeed,a[1]*this.options.scrollSpeed];this.lastScrolled=new Date();this.scrollInterval=setInterval(this.scroll.bind(this),10)},scroll:function(){var a=new Date();var b=a-this.lastScrolled;this.lastScrolled=a;if(this.options.scroll==window){with(this._getWindowScroll(this.options.scroll)){if(this.scrollSpeed[0]||this.scrollSpeed[1]){var c=b/1000;this.options.scroll.scrollTo(left+c*this.scrollSpeed[0],top+c*this.scrollSpeed[1])}}}else{this.options.scroll.scrollLeft+=this.scrollSpeed[0]*b/1000;this.options.scroll.scrollTop+=this.scrollSpeed[1]*b/1000}Position.prepare();Droppables.show(Draggables._lastPointer,this.element);Draggables.notify('onDrag',this);if(this._isScrollChild){Draggables._lastScrollPointer=Draggables._lastScrollPointer||$A(Draggables._lastPointer);Draggables._lastScrollPointer[0]+=this.scrollSpeed[0]*b/1000;Draggables._lastScrollPointer[1]+=this.scrollSpeed[1]*b/1000;if(Draggables._lastScrollPointer[0]<0)Draggables._lastScrollPointer[0]=0;if(Draggables._lastScrollPointer[1]<0)Draggables._lastScrollPointer[1]=0;this.draw(Draggables._lastScrollPointer)}if(this.options.change)this.options.change(this)},_getWindowScroll:function(a){var b,c,d,f;with(a.document){if(a.document.documentElement&&documentElement.scrollTop){b=documentElement.scrollTop;c=documentElement.scrollLeft}else if(a.document.body){b=body.scrollTop;c=body.scrollLeft}if(a.innerWidth){d=a.innerWidth;f=a.innerHeight}else if(a.document.documentElement&&documentElement.clientWidth){d=documentElement.clientWidth;f=documentElement.clientHeight}else{d=body.offsetWidth;f=body.offsetHeight}}return{top:b,left:c,width:d,height:f}}}var SortableObserver=Class.create();SortableObserver.prototype={initialize:function(a,b){this.element=$(a);this.observer=b;this.lastValue=Sortable.serialize(this.element)},onStart:function(){this.lastValue=Sortable.serialize(this.element)},onEnd:function(){Sortable.unmark();if(this.lastValue!=Sortable.serialize(this.element))this.observer(this.element)}}var Sortable={SERIALIZE_RULE:/^[^_\-](?:[A-Za-z0-9\-\_]*)[_](.*)$/,sortables:{},_findRootElement:function(a){while(a.tagName!="BODY"){if(a.id&&Sortable.sortables[a.id])return a;a=a.parentNode}},options:function(a){a=Sortable._findRootElement($(a));if(!a)return;return Sortable.sortables[a.id]},destroy:function(b){var c=Sortable.options(b);if(c){Draggables.removeObserver(c.element);c.droppables.each(function(a){Droppables.remove(a)});c.draggables.invoke('destroy');delete Sortable.sortables[c.element.id]}},create:function(c){c=$(c);var d=Object.extend({element:c,tag:'li',dropOnEmpty:false,tree:false,treeTag:'ul',overlap:'vertical',constraint:'vertical',containment:c,handle:false,only:false,delay:0,hoverclass:null,ghosting:false,scroll:false,scrollSensitivity:20,scrollSpeed:15,format:this.SERIALIZE_RULE,onChange:Prototype.emptyFunction,onUpdate:Prototype.emptyFunction},arguments[1]||{});this.destroy(c);var f={revert:true,scroll:d.scroll,scrollSpeed:d.scrollSpeed,scrollSensitivity:d.scrollSensitivity,delay:d.delay,ghosting:d.ghosting,constraint:d.constraint,handle:d.handle};if(d.starteffect)f.starteffect=d.starteffect;if(d.reverteffect)f.reverteffect=d.reverteffect;else if(d.ghosting)f.reverteffect=function(c){c.style.top=0;c.style.left=0};if(d.endeffect)f.endeffect=d.endeffect;if(d.zindex)f.zindex=d.zindex;var g={overlap:d.overlap,containment:d.containment,tree:d.tree,hoverclass:d.hoverclass,onHover:Sortable.onHover}var e={onHover:Sortable.onEmptyHover,overlap:d.overlap,containment:d.containment,hoverclass:d.hoverclass}Element.cleanWhitespace(c);d.draggables=[];d.droppables=[];if(d.dropOnEmpty||d.tree){Droppables.add(c,e);d.droppables.push(c)}(this.findElements(c,d)||[]).each(function(a){var b=d.handle?$(a).down('.'+d.handle,0):a;d.draggables.push(new Draggable(a,Object.extend(f,{handle:b})));Droppables.add(a,g);if(d.tree)a.treeNode=c;d.droppables.push(a)});if(d.tree){(Sortable.findTreeElements(c,d)||[]).each(function(a){Droppables.add(a,e);a.treeNode=c;d.droppables.push(a)})}this.sortables[c.id]=d;Draggables.addObserver(new SortableObserver(c,d.onUpdate))},findElements:function(a,b){return Element.findChildren(a,b.only,b.tree?true:false,b.tag)},findTreeElements:function(a,b){return Element.findChildren(a,b.only,b.tree?true:false,b.treeTag)},onHover:function(a,b,c){if(Element.isParent(b,a))return;if(c>.33&&c<.66&&Sortable.options(b).tree){return}else if(c>0.5){Sortable.mark(b,'before');if(b.previousSibling!=a){var d=a.parentNode;a.style.visibility="hidden";b.parentNode.insertBefore(a,b);if(b.parentNode!=d)Sortable.options(d).onChange(a);Sortable.options(b.parentNode).onChange(a)}}else{Sortable.mark(b,'after');var f=b.nextSibling||null;if(f!=a){var d=a.parentNode;a.style.visibility="hidden";b.parentNode.insertBefore(a,f);if(b.parentNode!=d)Sortable.options(d).onChange(a);Sortable.options(b.parentNode).onChange(a)}}},onEmptyHover:function(a,b,c){var d=a.parentNode;var f=Sortable.options(b);if(!Element.isParent(b,a)){var g;var e=Sortable.findElements(b,{tag:f.tag,only:f.only});var h=null;if(e){var j=Element.offsetSize(b,f.overlap)*(1.0-c);for(g=0;g<e.length;g+=1){if(j-Element.offsetSize(e[g],f.overlap)>=0){j-=Element.offsetSize(e[g],f.overlap)}else if(j-(Element.offsetSize(e[g],f.overlap)/2)>=0){h=g+1<e.length?e[g+1]:null;break}else{h=e[g];break}}}b.insertBefore(a,h);Sortable.options(d).onChange(a);f.onChange(a)}},unmark:function(){if(Sortable._marker)Sortable._marker.hide()},mark:function(a,b){var c=Sortable.options(a.parentNode);if(c&&!c.ghosting)return;if(!Sortable._marker){Sortable._marker=($('dropmarker')||Element.extend(document.createElement('DIV'))).hide().addClassName('dropmarker').setStyle({position:'absolute'});document.getElementsByTagName("body").item(0).appendChild(Sortable._marker)}var d=Position.cumulativeOffset(a);Sortable._marker.setStyle({left:d[0]+'px',top:d[1]+'px'});if(b=='after')if(c.overlap=='horizontal')Sortable._marker.setStyle({left:(d[0]+a.clientWidth)+'px'});else Sortable._marker.setStyle({top:(d[1]+a.clientHeight)+'px'});Sortable._marker.show()},_tree:function(a,b,c){var d=Sortable.findElements(a,b)||[];for(var f=0;f<d.length;++f){var g=d[f].id.match(b.format);if(!g)continue;var e={id:encodeURIComponent(g?g[1]:null),element:a,parent:c,children:[],position:c.children.length,container:$(d[f]).down(b.treeTag)}if(e.container)this._tree(e.container,b,e)c.children.push(e)}return c},tree:function(a){a=$(a);var b=this.options(a);var c=Object.extend({tag:b.tag,treeTag:b.treeTag,only:b.only,name:a.id,format:b.format},arguments[1]||{});var d={id:null,parent:null,children:[],container:a,position:0}return Sortable._tree(a,c,d)},_constructIndex:function(a){var b='';do{if(a.id)b='['+a.position+']'+b}while((a=a.parent)!=null);return b},sequence:function(b){b=$(b);var c=Object.extend(this.options(b),arguments[1]||{});return $(this.findElements(b,c)||[]).map(function(a){return a.id.match(c.format)?a.id.match(c.format)[1]:''})},setSequence:function(c,d){c=$(c);var f=Object.extend(this.options(c),arguments[2]||{});var g={};this.findElements(c,f).each(function(a){if(a.id.match(f.format))g[a.id.match(f.format)[1]]=[a,a.parentNode];a.parentNode.removeChild(a)});d.each(function(a){var b=g[a];if(b){b[1].appendChild(b[0]);delete g[a]}})},serialize:function(b){b=$(b);var c=Object.extend(Sortable.options(b),arguments[1]||{});var d=encodeURIComponent((arguments[1]&&arguments[1].name)?arguments[1].name:b.id);if(c.tree){return Sortable.tree(b,arguments[1]).children.map(function(a){return[d+Sortable._constructIndex(a)+"[id]="+encodeURIComponent(a.id)].concat(a.children.map(arguments.callee))}).flatten().join('&')}else{return Sortable.sequence(b,arguments[1]).map(function(a){return d+"[]="+encodeURIComponent(a)}).join('&')}}}Element.isParent=function(a,b){if(!a.parentNode||a==b)return false;if(a.parentNode==b)return true;return Element.isParent(a.parentNode,b)}Element.findChildren=function(c,d,f,g){if(!c.hasChildNodes())return null;g=g.toUpperCase();if(d)d=[d].flatten();var e=[];$A(c.childNodes).each(function(a){if(a.tagName&&a.tagName.toUpperCase()==g&&(!d||(Element.classNames(a).detect(function(v){return d.include(v)}))))e.push(a);if(f){var b=Element.findChildren(a,d,f,g);if(b)e.push(b)}});return(e.length>0?e.flatten():[])}Element.offsetSize=function(a,b){return a['offset'+((b=='vertical'||b=='height')?'Height':'Width')]}